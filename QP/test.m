% clc;
% clear;
% function callqpact

% B =[-0.1667         0    0.1667         0   -0.1667         0    0.1667         0    0.1489   -0.1489;
%          0   -0.2500         0    0.2500         0   -0.2500         0    0.2500         0         0;
%     0.1250   -0.2134    0.1250    0.4634    0.1250    0.2134    0.1250   -0.4634         0         0];
% 
% B_inv=[
% 
%    -1.0722   -0.0000    0.2144;
%          0   -1.0000   -0.3660;
%     1.0722   -0.0000    0.2144;
%          0    1.0000    0.7948;
%    -1.0722   -0.0000    0.2144;
%          0   -1.0000    0.3660;
%     1.0722   -0.0000    0.2144;
%          0    1.0000   -0.7948;
%     0.9578    0.0000   -0.0000;
%    -0.9578   -0.0000    0.0000];
%===============================================================
L_1=0.099;% roll,pitch
L_2=0.169;% T
L_3=L_1;% yaw1 yaw3
L_4=0.367;% yaw4
L_m=L_4-L_1;% yaw2
L_r_p=0.1;
B=[-1/6     0            1/6    0           -1/6    0           1/6    0     L_m/(6*3*L_r_p)  -L_m/(6*3*L_r_p);
    0      -1/4           0     1/4          0    -1/4          0     1/4          0           0;
    1/8    -L_2/(8*L_1)  1/8    L_4/(8*L_1)  1/8   L_2/(8*L_1)  1/8  -L_4/(8*L_1)  0           0];
umin=[[1;1;1;1;1;1;1;1]*-p_limits*pi/180;-0.3*9.788;-0.3*9.788];umax=[[1;1;1;1;1;1;1;1]*p_limits*pi/180;0.3*9.788;0.3*9.788];
%===================================幅值测试==================================================
[m,~]=size(umin);
N=100;
[X,Y,Z] = sphere(N);
%==================================速度约束测试==================================
t=0:0.01:1;
% X=0.33*sin(pi*t);
% Y=0.34*cos(pi*t);
% Z=0.17*sin(pi*t);
x=zeros(m,(N+1)^2);
x1=zeros(m,(N+1)^2);
iter=zeros((N+1)^2,1);
fval=zeros((N+1)^2,1);
t=zeros(3,(N+1)^2);
u=zeros(m,1);
u1=zeros(m,1);
p_limits=20;
for i=1:(N+1)^2%length(X)
v=1*[X(i);Y(i);Z(i)];% 虚拟指令
%==================有效集=====================
[u] = wls_alloc_mch(v, u, p_limits, false);
x(:,i)=u;
% [u1] = wls_alloc_mch(v, u1, p_limits, true);
u1=pinv(B)*v;
x1(:,i)=Constrain(u1,umin,umax);
end
U=B*x;
U1=B*x1;
figure(4),
plot3(U(1,:),U(2,:),U(3,:),'b*');
hold on;
plot3(U1(1,:),U1(2,:),U1(3,:),'r*');
% plot3(X,Y,Z,'b>');%zeros(length(X),1)
% hold on;
% plot3(UU(1,:),UU(2,:),UU(3,:),'b*');
% C=sqrt(U1.*U1+U2.*U2+U3.*U3);
% figure,
% surf(U1,U2,U3,C);% 'FaceColor','b','FaceAlpha',0.5,,'EdgeColor','none'